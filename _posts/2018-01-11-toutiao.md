---
layout: post
title: 今日头条公布算法原理
description:
date: 2018-01-11 19:57:44 +0800
image: assets/images/thumbnail/toutiao.png
---

作为一款基于数据挖掘的推荐引擎产品，为用户推荐信息，提供连接人与信息的服务的产品。大数据时代的新媒体业领头羊，今日头条的公布其算法原理可谓是业界的重磅炸弹。搜集了网上的相关暂时还没有详细信息，仅新闻快报，会持续关注。

>中国经济网北京1月11日讯 今日头条今日召开了一场旨在推动整个行业来问诊算法、建言算法的分享交流会。资深算法架构师、中国科学技术大学计算机博士曹欢欢，在今日头条总部带来了题为《让算法公开透明》的分享，面向行业公开算法原理，消除社会各界对算法的一些误解，同时接受意见和建议。  
100多位自中央电视台、新华社、人民日报技术局等媒体机构从业者，和阿里、腾讯、百度、美团、新浪、网易等科技公司的算法工程师和产品经理，参加了今天的分享与交流。  
多位参加交流的来宾反馈，今日头条公开算法的基本原理，并接受建言，体现出了一家平台对技术发展的责任感与诚意，这将对算法应用乃至整个互联网行业，起到巨大的积极推动作用。

-----
-----
>1月12日的新闻 [今日头条用了哪五种推荐算法？资深架构师曹欢欢首次公开揭秘
](https://36kr.com/p/5112750.html)  

1月11日，今日头条在总部举办了一场推荐算法交流会，因为报名人数远远超过了预期，交流会还临时换了场地。

据介绍，阿里、腾讯、百度、美团、新浪、网易等科技公司的算法工程师和产品经理都去了。看来大家对今日头条到底用了什么推荐算法，那是相当的好奇。

在当天的交流会上，今日头条资深算法架构师、中国科学技术大学计算机博士曹欢欢带来了题为《让算法公开透明》的分享，首次面向行业公开算法原理。

![今日头条资深算法架构师曹欢欢讲解今日头条算法原理](https://pic.36krcnd.com/avatar/201801/12095533/s0drwei44odh5z32.png!1200)

他表示：“算法分发并非是把所有决策都交给机器，我们会不断纠偏，设计、监督并管理算法模型。希望这次分享能让更多的人理解算法，并共同参与到算法模型的制定中来，以改善算法，更好的为用户服务，让算法为社会创造更大的价值。”

![](https://pic.36krcnd.com/avatar/201801/12084930/4pwyw48xouojvfem.png!1200)
据曹欢欢介绍，今日头条旗下几款产品都在沿用同一套大的算法推荐系统，但根据业务不同，每套系统的架构会有所调整。

曹欢欢在现场的`PPT`里公布了头条使用的五种推荐算法，包括传统的协同过滤模型，监督学习算法`Logistic Regression`模型，基于深度学习的`Factorization Machine`，以及`DNN`和`GBDT`。

曹欢欢介绍说，现在很难有一套通用的架构模型适用于所有的推荐场景，所以很多公司会做多个算法的组合，比如现在很流行将`LR`和`DNN`结合，甚至前几年`Facebook`也是将`LR`和`GBDT`算法做结合。今日头条也基本是一套大算法，根据业务不同再具体调整结构。

在解释了算法之后，曹欢欢进一步解密了头条的推荐如何工作。曹欢欢表示，主要有四类最重要的用户特征，将会输入给算法，影响到推荐算法的工作。
![](https://pic.36krcnd.com/avatar/201801/12085246/9ik3uiobqbi0wkcu.png!1200)

第一类是相关性特征，就是评估内容的属性和维度与用户是否匹配。显性的匹配包括关键词匹配、分类匹配、来源匹配、主题匹配等。像FM模型中也有一些隐性匹配，从用户向量与内容向量的核心距离可以得出。

第二类是环境特征，包括地理位置、时间。这些既是bias（基础）特征，也能以此构建一些匹配特征。

第三类是热度特征。包括全局热度、分类热度，主题热度，以及关键词热度等。热度信息在大的推荐系统特别在冷启动的时候非常有效。

第四类是协同特征，它可以在部分程度上帮助解决所谓算法越推越窄的问题。协同特征并非考虑用户已有历史。而是通过用户行为分析不同用户间相似性，比如点击相似、兴趣分类相似、主题相似、兴趣词相似，甚至向量相似，从而扩展模型的探索能力。

分享过后，曹欢欢在还解答了各位对算法的疑问，包括今日头条如何实现冷启动，广告和内容该怎样平衡，怎样准确地拓展用户兴趣图谱等切实的工程性问题。同时，也听取了大家对今日头条算法的意见和建议。

-----
-----
1月16日新闻 [今日头条推荐算法原理全文详解](https://36kr.com/p/5114077.html)
> 本次分享将主要介绍今日头条推荐系统概览以及内容分析、用户标签、评估分析，内容安全等原理。

如今，算法分发已经逐步成为信息平台、搜索引擎、浏览器、社交软件等几乎所有软件的标配，但同时也开始面临各种不同的质疑、挑战与误解。

`2018`年`1`月，今日头条资深算法架构师曹欢欢博士，首次公开今日头条的算法原理，以期推动整个行业问诊算法、建言算法。通过让算法透明，来消除各界对算法的误解。

据悉，今日头条的信息推荐算法自`2012`年`9`月第一版开发运行至今，已经经过四次大调整和修改。目前服务全球亿万用户。

#### 以下为曹欢欢关于《今日头条算法原理》的分享内容:

![](https://pic.36krcnd.com/avatar/201801/15154249/egdblny7enpnm9vt.jpeg!1200)

### 一、系统概览
推荐系统，如果用形式化的方式去描述实际上是拟合一个用户对内容满意度的函数，这个函数需要输入三个维度的变量。
![](https://pic.36krcnd.com/avatar/201801/15154252/b8tvjj3zffaybojh.jpeg!1200)

**第一个维度是内容。** 头条现在已经是一个综合内容平台，图文、视频、UGC小视频、问答、微头条，每种内容有很多自己的特征，需要考虑怎样提取不同内容类型的特征做好推荐。**第二个维度是用户特征。** 包括各种兴趣标签，职业、年龄、性别等，还有很多模型刻划出的隐式用户兴趣等。**第三个维度是环境特征。** 这是移动互联网时代推荐的特点，用户随时随地移动，在工作场合、通勤、旅游等不同的场景，信息偏好有所偏移。

结合三方面的维度，模型会给出一个预估，即推测推荐内容在这一场景下对这一用户是否合适。

这里还有一个问题，如何引入无法直接衡量的目标？

![](https://pic.36krcnd.com/avatar/201801/15154253/1tru0qaqj0rayuk5.jpeg!1200)

推荐模型中，点击率、阅读时间、点赞、评论、转发包括点赞都是可以量化的目标，能够用模型直接拟合做预估，看线上提升情况可以知道做的好不好。但一个大体量的推荐系统，服务用户众多，不能完全由指标评估，引入数据指标以外的要素也很重要。

比如广告和特型内容频控。像问答卡片就是比较特殊的内容形式，其推荐的目标不完全是让用户浏览，还要考虑吸引用户回答为社区贡献内容。这些内容和普通内容如何混排，怎样控制频控都需要考虑。

此外， **平台出于内容生态和社会责任的考量，像低俗内容的打压，标题党、低质内容的打压，重要新闻的置顶、加权、强插，低级别账号内容降权都是算法本身无法完成，需要进一步对内容进行干预。**  

下面我将简单介绍在上述算法目标的基础上如何对其实现。

![](https://pic.36krcnd.com/avatar/201801/15154253/akfjjicju89i66ar.jpeg!1200)

前面提到的公式`y = F(Xi ,Xu ,Xc)`，是一个很经典的监督学习问题。可实现的方法有很多，比如传统的协同过滤模型，监督学习算法`Logistic Regression`模型，基于深度学习的模型，`Factorization Machine`和`GBDT`等。

一个优秀的工业级推荐系统需要非常灵活的算法实验平台，可以支持多种算法组合，包括模型结构调整。因为很难有一套通用的模型架构适用于所有的推荐场景。现在很流行将`LR`和`DNN`结合，前几年`Facebook`也将`LR`和`GBDT`算法做结合。今日头条旗下几款产品都在沿用同一套强大的算法推荐系统，但根据业务场景不同，模型架构会有所调整。

![](https://pic.36krcnd.com/avatar/201801/15154252/2ufgveuh9kalwd42.jpeg!1200)


模型之后再看一下典型的推荐特征，主要有四类特征会对推荐起到比较重要的作用。

**第一类是相关性特征，就是评估内容的属性和与用户是否匹配。** 显性的匹配包括关键词匹配、分类匹配、来源匹配、主题匹配等。像FM模型中也有一些隐性匹配，从用户向量与内容向量的距离可以得出。

**第二类是环境特征，包括地理位置、时间。这些既是bias特征，也能以此构建一些匹配特征。**

**第三类是热度特征。** 包括全局热度、分类热度，主题热度，以及关键词热度等。内容热度信息在大的推荐系统特别在用户冷启动的时候非常有效。

**第四类是协同特征，它可以在部分程度上帮助解决所谓算法越推越窄的问题。** 协同特征并非考虑用户已有历史。而是通过用户行为分析不同用户间相似性，比如点击相似、兴趣分类相似、主题相似、兴趣词相似，甚至向量相似，从而扩展模型的探索能力。

![](https://pic.36krcnd.com/avatar/201801/15154253/ctle81m5pnghemqo.jpeg!1200)

模型的训练上，头条系大部分推荐产品采用实时训练。实时训练省资源并且反馈快，这对信息流产品非常重要。用户需要行为信息可以被模型快速捕捉并反馈至下一刷的推荐效果。我们线上目前基于`storm`集群实时处理样本数据，包括点击、展现、收藏、分享等动作类型。模型参数服务器是内部开发的一套高性能的系统，因为头条数据规模增长太快，类似的开源系统稳定性和性能无法满足，而我们自研的系统底层做了很多针对性的优化，提供了完善运维工具，更适配现有的业务场景。

目前，头条的推荐算法模型在世界范围内也是比较大的，包含几百亿原始特征和数十亿向量特征。整体的训练过程是线上服务器记录实时特征，导入到`Kafka`文件队列中，然后进一步导入`Storm`集群消费`Kafka`数据，客户端回传推荐的`label`构造训练样本，随后根据最新样本进行在线训练更新模型参数，最终线上模型得到更新。这个过程中主要的延迟在用户的动作反馈延时，因为文章推荐后用户不一定马上看，不考虑这部分时间，整个系统是几乎实时的。

![](https://pic.36krcnd.com/avatar/201801/15154253/8yitwoytgmtnd168.jpeg!1200)

但因为头条目前的内容量非常大，加上小视频内容有千万级别，推荐系统不可能所有内容全部由模型预估。所以需要设计一些召回策略，每次推荐时从海量内容中筛选出千级别的内容库。召回策略最重要的要求是性能要极致，一般超时不能超过`50`毫秒。

![](https://pic.36krcnd.com/avatar/201801/15154253/ar1sm8q55u919pc3.jpeg!1200)

召回策略种类有很多，我们主要用的是倒排的思路。离线维护一个倒排，这个倒排的`key`可以是分类，`topic`，实体，来源等，排序考虑热度、新鲜度、动作等。线上召回可以迅速从倒排中根据用户兴趣标签对内容做截断，高效的从很大的内容库中筛选比较靠谱的一小部分内容。

![](https://pic.36krcnd.com/avatar/201801/15154253/url1prwqngvrjx0f.jpeg!1200)

### 二、内容分析

内容分析包括文本分析，图片分析和视频分析。头条一开始主要做资讯，今天我们主要讲一下文本分析。文本分析在推荐系统中一个很重要的作用是用户兴趣建模。没有内容及文本标签，无法得到用户兴趣标签。举个例子，只有知道文章标签是互联网，用户看了互联网标签的文章，才能知道用户有互联网标签，其他关键词也一样。

![](https://pic.36krcnd.com/avatar/201801/15160517/rqnahcdwtmv1xzez.jpeg!1200)

另一方面，文本内容的标签可以直接帮助推荐特征，比如魅族的内容可以推荐给关注魅族的用户，这是用户标签的匹配。如果某段时间推荐主频道效果不理想，出现推荐窄化，用户会发现到具体的频道推荐（如科技、体育、娱乐、军事等）中阅读后，再回主`feed`,推荐效果会更好。因为整个模型是打通的，子频道探索空间较小，更容易满足用户需求。只通过单一信道反馈提高推荐准确率难度会比较大，子频道做的好很重要。而这也需要好的内容分析。

![](https://pic.36krcnd.com/avatar/201801/15160538/rnky59il2od10fn9.jpeg!1200)

上图是今日头条的一个实际文本`case`。可以看到，这篇文章有分类、关键词、`topic`、实体词等文本特征。当然不是没有文本特征，推荐系统就不能工作，推荐系统最早期应用在`Amazon`,甚至沃尔玛时代就有，包括`Netfilx`做视频推荐也没有文本特征直接协同过滤推荐。但对资讯类产品而言，大部分是消费当天内容，没有文本特征新内容冷启动非常困难，协同类特征无法解决文章冷启动问题。

![](https://pic.36krcnd.com/avatar/201801/15160549/1o62umwiaef0gado.jpeg!1200)

今日头条推荐系统主要抽取的文本特征包括以下几类。首先是语义标签类特征，显式为文章打上语义标签。这部分标签是由人定义的特征，每个标签有明确的意义，标签体系是预定义的。此外还有隐式语义特征，主要是`topic`特征和关键词特征，其中`topic`特征是对于词概率分布的描述，无明确意义；而关键词特征会基于一些统一特征描述，无明确集合。

![](https://pic.36krcnd.com/avatar/201801/15160643/qr5rt30sjdud81eq.jpeg!1200)

另外文本相似度特征也非常重要。在头条，曾经用户反馈最大的问题之一就是为什么总推荐重复的内容。这个问题的难点在于，每个人对重复的定义不一样。举个例子，有人觉得这篇讲皇马和巴萨的文章，昨天已经看过类似内容，今天还说这两个队那就是重复。但对于一个重度球迷而言，尤其是巴萨的球迷，恨不得所有报道都看一遍。解决这一问题需要根据判断相似文章的主题、行文、主体等内容，根据这些特征做线上策略。

同样，还有时空特征，分析内容的发生地点以及时效性。比如武汉限行的事情推给北京用户可能就没有意义。最后还要考虑质量相关特征，判断内容是否低俗，色情，是否是软文，鸡汤？











-----
-----
## 此次今日头条公布推荐算法原理事件观后感

这次算法公开更像是一次交流大会，收益的不光是听众，
